name: Check PR before merge
on:
  pull_request:
    branches:
    - '*'

jobs:
  check-for-errors:
    # These permissions are needed to interact with GitHub's OIDC Token endpoint.
    permissions:
      id-token: write
      contents: read
      issues: read
      # permission needed to post a comment on the PR
      pull-requests: write

    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1
      - name: Check for merge conflict markers
        run: scripts/check_merge_conflict_markers.sh .
      - name: Check there are no 404 links
        id: check404
        run: |
          set -xeuo pipefail
          result_file=$(mktemp)
          set +e
          scripts/check-links.sh > "$result_file"
          rv=$?
          set -e
          if [[ "$rv" != 0 ]]; then
            cat "$result_file"
            {
              # Abusing the unique name of the file as an EOF marker
              echo "output<<$result_file"
              cat "$result_file"
              echo "$result_file"
            } >> $GITHUB_OUTPUT
          fi
          exit "$rv"

      - name: Find Comment
        id: fc
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e  # v3.1.0
        if: always()
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Link Check Status:"

      - name: Post a comment on failure
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043  # v4.0.0
        if: failure()
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            # $\color{red}{\text{üß® Link Check Status: FAILURE}}$
            ```
            ${{ steps.check404.outputs.output }}
            ```
          edit-mode: replace

      - name: Post a comment on success
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043  # v4.0.0
        if: success()
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            # $\color{green}{\text{üëç Link Check Status: SUCCESS}}$
          edit-mode: replace
